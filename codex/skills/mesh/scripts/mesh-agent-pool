#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=mesh-lib.sh
source "${SCRIPT_DIR}/mesh-lib.sh"

usage() {
  cat <<'USAGE'
Usage: mesh-agent-pool [GLOBAL_FLAGS] <command> [args...]

Manage durable mesh agent beads and hook slots.

Commands:
  ensure [--count N] [--prefix NAME-] [--start N] [--rig RIG] [--role-type ROLE] <name...>
      Ensure agent beads exist for the provided names.
      If --count is set and no names are provided, generate names (prefix + index).

  id <name>
      Print the agent bead id for a name.

  acquire [--rig RIG] [--role-type ROLE] [--force] <name> <work-bead-id>
      Ensure agent exists, set hook slot to work bead, mark working.
      By default, refuses to override a non-empty hook (use --force to override).

  release <name>
      Clear hook slot and mark agent idle.

  doctor [--count N] [--prefix NAME-] [--start N] [--max-age SECONDS] [--release-stale] <name...>
      Inspect agent hooks and liveness; optionally release stale hooks.
      If --count is set and no names are provided, generate names (prefix + index).

Global flags:
  -h, --help     Show help and exit
  --dry-run      Print intended actions without executing
  --json         Emit machine-readable JSON output
USAGE
}

mesh_require_cmd bd
mesh_require_cmd jq

DEFAULT_RIG="${MESH_AGENT_RIG:-codex}"
DEFAULT_ROLE="${MESH_AGENT_ROLE:-polecat}"
DEFAULT_PREFIX="${MESH_AGENT_PREFIX:-mesh-}"
DEFAULT_START="${MESH_AGENT_START:-1}"

mesh_parse_common_flags "$@"

if [[ ${MESH_HELP} -eq 1 ]]; then
  usage
  exit 0
fi

if [[ ${#MESH_ARGS[@]} -eq 0 ]]; then
  usage >&2
  exit 1
fi

set -- "${MESH_ARGS[@]}"
cmd="$1"
shift

agent_id_for_name() {
  local name="$1"
  local json
  json="$(bd list --label "agent:${name}" --all --json)"
  local count
  count="$(jq 'length' <<<"${json}")"
  if [[ "${count}" -eq 0 ]]; then
    return 1
  fi
  if [[ "${count}" -gt 1 ]]; then
    mesh_die "mesh-agent-pool: multiple agents found for name: ${name}"
  fi
  jq -r '.[0].id' <<<"${json}"
}

extract_hook_from_json() {
  local json="$1"
  jq -r '(.slots.hook? // empty),
    (.. | objects | select((.name? // "") == "hook") | (.target_id? // .target? // .value? // .bead_id? // .id? // .hook? // empty))
    | select(. != "")' <<<"${json}" | head -n1 || true
}

agent_hook_for_id() {
  local id="$1"
  local json
  local hook=""

  if json="$(bd slot show "${id}" --json 2>/dev/null)"; then
    hook="$(extract_hook_from_json "${json}")"
    printf '%s' "${hook}"
    return 0
  fi

  local text
  if text="$(bd slot show "${id}" 2>/dev/null)"; then
    hook="$(awk -F: '/^[[:space:]]*hook[[:space:]]*:/ {print $2}' <<<"${text}" | xargs || true)"
    printf '%s' "${hook}"
    return 0
  fi

  return 2
}

mesh_epoch_from_iso() {
  local ts="$1"
  local clean
  clean="$(printf '%s' "${ts}" | sed -E 's/\.[0-9]+//; s/([+-][0-9]{2}):([0-9]{2})/\1\2/')"
  if date -u -j -f "%Y-%m-%dT%H:%M:%S%z" "${clean}" +%s 2>/dev/null; then
    return 0
  fi
  if date -u -d "${ts}" +%s 2>/dev/null; then
    return 0
  fi
  return 1
}

process_state_for_hook() {
  local hook="$1"
  local name="$2"
  if [[ -z "${hook}" || "${hook}" == "null" ]]; then
    echo "missing"
    return 0
  fi
  if ! command -v pgrep >/dev/null 2>&1; then
    echo "unknown"
    return 0
  fi
  if pgrep -f "codex.*${hook}" >/dev/null 2>&1; then
    echo "running"
    return 0
  fi
  if [[ -n "${name}" ]] && pgrep -f "codex.*${name}" >/dev/null 2>&1; then
    echo "running"
    return 0
  fi
  echo "missing"
}

emit_doctor() {
  local name="$1"
  local id="$2"
  local hook="$3"
  local state="$4"
  local last_activity="$5"
  local age="$6"
  local process_state="$7"
  local stale="$8"
  local released="$9"

  if [[ ${MESH_JSON} -eq 1 ]]; then
    jq -n \
      --arg name "${name}" \
      --arg id "${id}" \
      --arg hook "${hook}" \
      --arg state "${state}" \
      --arg last_activity "${last_activity}" \
      --arg process_state "${process_state}" \
      --argjson age "${age:-null}" \
      --argjson stale "${stale}" \
      --argjson released "${released}" \
      '{ok:true,action:"doctor",agent_name:$name,agent_id:$id,hook_bead:$hook,agent_state:$state,last_activity:$last_activity,age_seconds:$age,process_state:$process_state,stale:$stale,released:$released}'
    return 0
  fi

  local age_text="age=?"
  if [[ -n "${age}" ]]; then
    age_text="age=${age}s"
  fi
  local hook_text="hook=${hook:-none}"
  if [[ -z "${hook}" || "${hook}" == "null" ]]; then
    hook_text="hook=none"
  fi
  local state_text="state=${state:-unknown}"
  local released_text="released=no"
  if [[ "${released}" -eq 1 ]]; then
    released_text="released=yes"
  fi
  local stale_text="stale=no"
  if [[ "${stale}" -eq 1 ]]; then
    stale_text="stale=yes"
  fi
  echo "doctor: ${name} -> ${id} ${state_text} ${hook_text} ${age_text} process=${process_state} ${stale_text} ${released_text}"
}

emit_agent() {
  local action="$1"
  local name="$2"
  local id="$3"
  if [[ ${MESH_JSON} -eq 1 ]]; then
    if [[ -n "${id}" ]]; then
      jq -n --arg action "${action}" --arg name "${name}" --arg id "${id}" \
        '{ok:true,action:$action,agent_name:$name,agent_id:$id}'
    else
      jq -n --arg action "${action}" --arg name "${name}" \
        '{ok:true,action:$action,agent_name:$name,agent_id:null}'
    fi
    return 0
  fi
  if [[ -n "${id}" ]]; then
    echo "${action}: ${name} -> ${id}"
  else
    echo "${action}: ${name}"
  fi
}

ensure_agent() {
  local name="$1"
  local rig="$2"
  local role="$3"
  local id=""

  if id="$(agent_id_for_name "${name}")"; then
    if [[ ${MESH_DRY_RUN} -eq 1 ]]; then
      mesh_emit "dry-run: bd label add ${id} gt:agent"
    else
      bd label add "${id}" gt:agent >/dev/null 2>&1 || true
    fi
    echo "${id}"
    return 0
  fi

  local labels="gt:agent,agent,agent:${name},role:${role}"

  if [[ ${MESH_DRY_RUN} -eq 1 ]]; then
    mesh_emit "dry-run: bd create --type=agent --role-type ${role} --agent-rig ${rig} --labels ${labels} --title ${name}"
    echo ""
    return 0
  fi

  id="$(bd create --type=agent --role-type "${role}" --agent-rig "${rig}" \
    --labels "${labels}" --title "${name}" --silent)"
  bd --actor "agent:${name}" agent state "${id}" idle
  echo "${id}"
}

case "${cmd}" in
  ensure)
    rig="${DEFAULT_RIG}"
    role="${DEFAULT_ROLE}"
    prefix="${DEFAULT_PREFIX}"
    start="${DEFAULT_START}"
    count=""

    while [[ $# -gt 0 ]]; do
      case "$1" in
        --rig)
          rig="$2"
          shift 2
          ;;
        --role-type)
          role="$2"
          shift 2
          ;;
        --prefix)
          prefix="$2"
          shift 2
          ;;
        --start)
          start="$2"
          shift 2
          ;;
        --count)
          count="$2"
          shift 2
          ;;
        --)
          shift
          break
          ;;
        -* )
          mesh_die "mesh-agent-pool ensure: unknown flag: $1"
          ;;
        *)
          break
          ;;
      esac
    done

    names=()
    if [[ -n "${count}" ]]; then
      if [[ $# -gt 0 ]]; then
        mesh_die "mesh-agent-pool ensure: cannot combine --count with explicit names"
      fi
      if ! [[ "${count}" =~ ^[0-9]+$ ]]; then
        mesh_die "mesh-agent-pool ensure: --count must be an integer"
      fi
      if ! [[ "${start}" =~ ^[0-9]+$ ]]; then
        mesh_die "mesh-agent-pool ensure: --start must be an integer"
      fi
      for ((i=start; i<start+count; i++)); do
        names+=("${prefix}${i}")
      done
    else
      names=("$@")
    fi

    if [[ ${#names[@]} -eq 0 ]]; then
      mesh_die "mesh-agent-pool ensure: no agent names provided"
    fi

    for name in "${names[@]}"; do
      id="$(ensure_agent "${name}" "${rig}" "${role}")"
      emit_agent "ensure" "${name}" "${id}"
    done
    ;;

  id)
    if [[ $# -lt 1 ]]; then
      mesh_die "mesh-agent-pool id: requires agent name"
    fi
    name="$1"
    id="$(agent_id_for_name "${name}")" || mesh_die "mesh-agent-pool id: agent not found: ${name}"
    if [[ ${MESH_JSON} -eq 1 ]]; then
      jq -n --arg name "${name}" --arg id "${id}" '{ok:true,agent_name:$name,agent_id:$id}'
    else
      echo "${id}"
    fi
    ;;

  acquire)
    rig="${DEFAULT_RIG}"
    role="${DEFAULT_ROLE}"
    force=0

    while [[ $# -gt 0 ]]; do
      case "$1" in
        --rig)
          rig="$2"
          shift 2
          ;;
        --role-type)
          role="$2"
          shift 2
          ;;
        --force)
          force=1
          shift
          ;;
        --)
          shift
          break
          ;;
        -* )
          mesh_die "mesh-agent-pool acquire: unknown flag: $1"
          ;;
        *)
          break
          ;;
      esac
    done

    if [[ $# -lt 2 ]]; then
      mesh_die "mesh-agent-pool acquire: requires <name> <work-bead-id>"
    fi

    name="$1"
    work_id="$2"
    id="$(ensure_agent "${name}" "${rig}" "${role}")"

    if [[ -z "${id}" && ${MESH_DRY_RUN} -ne 1 ]]; then
      mesh_die "mesh-agent-pool acquire: failed to resolve agent id for ${name}"
    fi

    hook=""
    if [[ ${MESH_DRY_RUN} -ne 1 ]]; then
      hook="$(agent_hook_for_id "${id}")" || mesh_die "mesh-agent-pool acquire: failed to read hook slot for ${name}"
      if [[ ${force} -ne 1 && -n "${hook}" && "${hook}" != "${work_id}" ]]; then
        mesh_die "mesh-agent-pool acquire: hook already set to ${hook} (use --force to override)"
      fi
    fi

    target_id="${id:-agent:${name}}"
    if [[ ${MESH_DRY_RUN} -eq 1 || -z "${hook}" || "${hook}" != "${work_id}" ]]; then
      mesh_run bd --actor "agent:${name}" slot set "${target_id}" hook "${work_id}"
    fi
    mesh_run bd --actor "agent:${name}" agent state "${target_id}" working
    emit_agent "acquire" "${name}" "${id}"
    ;;

  release)
    if [[ $# -lt 1 ]]; then
      mesh_die "mesh-agent-pool release: requires <name>"
    fi
    name="$1"
    id="$(agent_id_for_name "${name}")" || true

    if [[ -z "${id}" && ${MESH_DRY_RUN} -ne 1 ]]; then
      mesh_die "mesh-agent-pool release: agent not found: ${name}"
    fi

    target_id="${id:-agent:${name}}"
    mesh_run bd --actor "agent:${name}" slot clear "${target_id}" hook
    mesh_run bd --actor "agent:${name}" agent state "${target_id}" idle
    emit_agent "release" "${name}" "${id}"
    ;;

  doctor)
    prefix="${DEFAULT_PREFIX}"
    start="${DEFAULT_START}"
    count=""
    max_age="${MESH_STALE_HOOK_TTL_SECONDS:-3600}"
    release_stale=0

    while [[ $# -gt 0 ]]; do
      case "$1" in
        --prefix)
          prefix="$2"
          shift 2
          ;;
        --start)
          start="$2"
          shift 2
          ;;
        --count)
          count="$2"
          shift 2
          ;;
        --max-age)
          max_age="$2"
          shift 2
          ;;
        --release-stale)
          release_stale=1
          shift
          ;;
        --)
          shift
          break
          ;;
        -* )
          mesh_die "mesh-agent-pool doctor: unknown flag: $1"
          ;;
        *)
          break
          ;;
      esac
    done

    if ! [[ "${max_age}" =~ ^[0-9]+$ ]]; then
      mesh_die "mesh-agent-pool doctor: --max-age must be an integer"
    fi
    if ! [[ "${start}" =~ ^[0-9]+$ ]]; then
      mesh_die "mesh-agent-pool doctor: --start must be an integer"
    fi
    if [[ -n "${count}" && ! "${count}" =~ ^[0-9]+$ ]]; then
      mesh_die "mesh-agent-pool doctor: --count must be an integer"
    fi

    names=()
    if [[ -n "${count}" ]]; then
      if [[ $# -gt 0 ]]; then
        mesh_die "mesh-agent-pool doctor: cannot combine --count with explicit names"
      fi
      for ((i=start; i<start+count; i++)); do
        names+=("${prefix}${i}")
      done
    else
      names=("$@")
    fi

    if [[ ${#names[@]} -eq 0 ]]; then
      mesh_die "mesh-agent-pool doctor: no agent names provided"
    fi

    now="$(date -u +%s)"
    for name in "${names[@]}"; do
      id=""
      if ! id="$(agent_id_for_name "${name}")"; then
        emit_doctor "${name}" "" "" "" "" "" "missing" 0 0
        continue
      fi

      agent_json=""
      if ! agent_json="$(bd show "${id}" --json 2>/dev/null)"; then
        emit_doctor "${name}" "${id}" "" "" "" "" "missing" 0 0
        continue
      fi

      hook="$(jq -r '.[0].hook_bead // empty' <<<"${agent_json}")"
      state="$(jq -r '.[0].agent_state // empty' <<<"${agent_json}")"
      last_activity="$(jq -r '.[0].last_activity // empty' <<<"${agent_json}")"
      age=""
      if [[ -n "${last_activity}" && "${last_activity}" != "null" ]]; then
        if last_epoch="$(mesh_epoch_from_iso "${last_activity}")"; then
          age=$((now - last_epoch))
        fi
      fi

      process_state="$(process_state_for_hook "${hook}" "${name}")"
      stale=0
      if [[ -n "${hook}" && "${hook}" != "null" && -n "${age}" ]]; then
        if [[ "${age}" -ge "${max_age}" && "${process_state}" == "missing" ]]; then
          stale=1
        fi
      fi

      released=0
      if [[ "${release_stale}" -eq 1 && "${stale}" -eq 1 ]]; then
        target_id="${id:-agent:${name}}"
        mesh_run bd --actor "agent:${name}" slot clear "${target_id}" hook
        mesh_run bd --actor "agent:${name}" agent state "${target_id}" idle
        released=1
      fi

      emit_doctor "${name}" "${id}" "${hook}" "${state}" "${last_activity}" "${age}" "${process_state}" "${stale}" "${released}"
    done
    ;;

  *)
    mesh_die "mesh-agent-pool: unknown command: ${cmd}"
    ;;
esac
