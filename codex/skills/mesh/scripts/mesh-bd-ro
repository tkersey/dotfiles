#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=mesh-lib.sh
source "${SCRIPT_DIR}/mesh-lib.sh"

usage() {
  cat <<'EOF'
Usage: mesh-bd-ro [GLOBAL_FLAGS] <command> [args...]

Runs: bd --readonly --sandbox <command...>

Global flags (allowlisted):
  -h, --help
  --json
  -q, --quiet
  -v, --verbose

Allowlisted commands:
  show <id...>
  list [args...]
  ready [args...]
  blocked [args...]
  search <query>
  count [args...]
  status [args...]
  state [args...]
  dep list|tree|cycles [args...]
  mol show|current|progress [args...]
  swarm status|validate|list [args...]
  epic status [args...]

Use command-specific help via: mesh-bd-ro <command> --help
EOF
}

mesh_require_cmd bd

declare -a global_flags=()
want_help=0

deny_disallowed_globals() {
  local arg
  for arg in "$@"; do
    case "$arg" in
      --actor|--actor=*)
        mesh_die "mesh-bd-ro: disallowed global flag: --actor"
        ;;
      --db|--db=*)
        mesh_die "mesh-bd-ro: disallowed global flag: --db"
        ;;
      --profile|--profile=*)
        mesh_die "mesh-bd-ro: disallowed global flag: --profile"
        ;;
      --allow-stale|--allow-stale=*)
        mesh_die "mesh-bd-ro: disallowed global flag: --allow-stale"
        ;;
      --lock-timeout|--lock-timeout=*)
        mesh_die "mesh-bd-ro: disallowed global flag: --lock-timeout"
        ;;
      --no-*)
        mesh_die "mesh-bd-ro: disallowed global flag: $arg"
        ;;
    esac
  done
}

require_positional() {
  local name="$1"
  shift
  local arg
  for arg in "$@"; do
    if [[ "$arg" != -* ]]; then
      return 0
    fi
  done
  mesh_die "mesh-bd-ro: ${name} requires at least one positional argument"
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)
      want_help=1
      global_flags+=("$1")
      shift
      ;;
    --json|-q|--quiet|-v|--verbose)
      global_flags+=("$1")
      shift
      ;;
    --)
      shift
      break
      ;;
    -*)
      mesh_die "mesh-bd-ro: disallowed global flag: $1"
      ;;
    *)
      break
      ;;
  esac
done

if [[ $want_help -eq 1 && $# -eq 0 ]]; then
  usage
  exit 0
fi

if [[ $# -eq 0 ]]; then
  usage >&2
  exit 1
fi

cmd="$1"
shift
sub=""
path="$cmd"

case "$cmd" in
  dep|mol|swarm|epic)
    if [[ $# -eq 0 ]]; then
      mesh_die "mesh-bd-ro: missing subcommand for ${cmd}"
    fi
    sub="$1"
    shift
    path="${cmd} ${sub}"
    ;;
esac

case "$path" in
  show|list|ready|blocked|search|count|status|state)
    ;;
  "dep list"|"dep tree"|"dep cycles")
    ;;
  "mol show"|"mol current"|"mol progress")
    ;;
  "swarm status"|"swarm validate"|"swarm list")
    ;;
  "epic status")
    ;;
  *)
    mesh_die "mesh-bd-ro: disallowed command: ${path}"
    ;;
esac

if [[ $want_help -eq 1 ]]; then
  usage
  exit 0
fi

deny_disallowed_globals "$@"

case "$path" in
  show)
    require_positional "show" "$@"
    ;;
  search)
    require_positional "search" "$@"
    ;;
esac

cmd_args=()
cmd_args+=("$cmd")
if [[ -n "$sub" ]]; then
  cmd_args+=("$sub")
fi
cmd_args+=("$@")

if [[ ${#global_flags[@]} -gt 0 ]]; then
  exec bd --readonly --sandbox "${global_flags[@]}" "${cmd_args[@]}"
fi

exec bd --readonly --sandbox "${cmd_args[@]}"
