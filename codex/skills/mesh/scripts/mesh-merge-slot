#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=mesh-lib.sh
# shellcheck disable=SC1091
source "${SCRIPT_DIR}/mesh-lib.sh"

usage() {
  cat <<'USAGE'
Usage: mesh-merge-slot [GLOBAL_FLAGS] <command> [args...]

Wrapper for bd merge-slot acquire/release.

Commands:
  acquire [args...]     Attempt to acquire merge slot (default non-blocking)
  release [args...]     Release merge slot

Config:
  MESH_MERGE_SLOT_WAIT=1  Default to --wait on acquire (opt-in)

Notes:
  - Without --wait (default), acquire returns non-zero if slot is held.
  - Global --dry-run prints intended bd merge-slot command.

Global flags:
  -h, --help     Show help and exit
  --dry-run      Print intended actions without executing
  --json         Emit machine-readable JSON output
USAGE
}

mesh_require_cmd bd

mesh_parse_common_flags "$@"

if [[ ${MESH_HELP} -eq 1 ]]; then
  usage
  exit 0
fi

if [[ ${#MESH_ARGS[@]} -eq 0 ]]; then
  usage >&2
  exit 1
fi

set -- "${MESH_ARGS[@]}"
cmd="$1"
shift

usage_error() {
  echo "error: $*" >&2
  usage >&2
  exit 2
}

mesh_bool() {
  case "${1:-}" in
    1|true|TRUE|yes|YES|on|ON)
      echo 1
      ;;
    0|false|FALSE|no|NO|off|OFF)
      echo 0
      ;;
    *)
      echo ""
      ;;
  esac
}

has_json_flag() {
  local arg
  for arg in "$@"; do
    case "${arg}" in
      --json)
        return 0
        ;;
    esac
  done
  return 1
}

has_wait_flag() {
  local arg
  for arg in "$@"; do
    case "${arg}" in
      --wait)
        return 0
        ;;
    esac
  done
  return 1
}

mesh_cmd_string() {
  local out=""
  local arg
  for arg in "$@"; do
    out+="${arg} "
  done
  printf '%s' "${out% }"
}

run_merge_slot() {
  local subcmd="$1"
  shift
  local -a args=("$@")

  if [[ ${MESH_JSON} -eq 1 ]] && ! has_json_flag "${args[@]}"; then
    args+=("--json")
  fi

  if [[ ${MESH_DRY_RUN} -eq 1 ]]; then
    mesh_emit "dry-run: $(mesh_cmd_string bd merge-slot "${subcmd}" "${args[@]}")"
    return 0
  fi

  exec bd merge-slot "${subcmd}" "${args[@]}"
}

case "${cmd}" in
  acquire)
    default_wait=""
    raw_default="${MESH_MERGE_SLOT_WAIT:-}"
    if [[ -n "${raw_default}" ]]; then
      default_wait="$(mesh_bool "${raw_default}")"
      if [[ -z "${default_wait}" ]]; then
        usage_error "mesh-merge-slot: invalid MESH_MERGE_SLOT_WAIT value: ${raw_default}"
      fi
    fi

    acquire_args=("$@")
    if [[ "${default_wait}" == "1" ]] && ! has_wait_flag "${acquire_args[@]}"; then
      acquire_args+=("--wait")
    fi

    run_merge_slot acquire "${acquire_args[@]}"
    ;;
  release)
    run_merge_slot release "$@"
    ;;
  *)
    usage_error "mesh-merge-slot: unknown command: ${cmd}"
    ;;
esac
